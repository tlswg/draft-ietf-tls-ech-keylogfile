---
title: "SSLKEYLOGFILE Extension for Encrypted Client Hello (ECH)"
category: info

docname: draft-ietf-tls-ech-keylogfile-latest
submissiontype: IETF  # also: "independent", "editorial", "IAB", or "IRTF"
number:
date:
consensus: true
v: 3
area: "Security"
workgroup: "Transport Layer Security"
keyword:
 - encrypted client hello
 - sslkeylog
venue:
  group: "Transport Layer Security"
  type: "Working Group"
  mail: "tls@ietf.org"
  arch: "https://mailarchive.ietf.org/arch/browse/tls/"
  github: "tlswg/draft-ietf-tls-ech-keylogfile"
  latest: "https://tlswg.github.io/draft-ietf-tls-ech-keylogfile/draft-ietf-tls-ech-keylogfile.html"

author:
 -
    ins: "Y. Rosomakho"
    fullname: Yaroslav Rosomakho
    organization: Zscaler
    email: yrosomakho@zscaler.com
 -
   name: Hannes Tschofenig
   org: University of Applied Sciences Bonn-Rhein-Sieg
   abbrev: H-BRS
   email: Hannes.Tschofenig@gmx.net

normative:

informative:


--- abstract

This document specifies an extension to the SSLKEYLOGFILE format to support the logging of information about Encrypted Client Hello (ECH) related secrets. Two new labels are introduced, namely ECH_SECRET and ECH_CONFIG, which log the Hybrid Public Key Encryption (HPKE)-derived shared secret and the ECHConfig used for the ECH, respectively.

This extension aims to facilitate debugging of TLS connections employing ECH.

--- middle

# Introduction

Debugging protocols with TLS can be difficult due to encrypted communications. Analyzing these messages in diagnostic and debug tools requires inspecting the encrypted content. Various TLS implementations have informally adopted a file format to log the secret values generated by the TLS key schedule, aiding in this analysis.

In many implementations, the file that the secrets are logged to is specified in an environment variable named "SSLKEYLOGFILE". {{!I-D.ietf-tls-keylogfile}} standardizes this format.  With the introduction of {{!I-D.ietf-tls-esni}} additional secrets are derived during the handshake to encrypt the ClientHello message using Hybrid Public Key Encryption (HPKE) {{?RFC9180}}. This document extends the SSLKEYLOGFILE format to also offer support for the ECH extension to enable debugging of ECH-enabled connections. The proposed extension can also be used with all protocols that support ECH, including TLS 1.3 {{?RFC8446}}, DTLS 1.3 {{?RFC9147}} and QUIC {{?RFC9000}}{{?RFC9001}}.

# Conventions and Definitions

{::boilerplate bcp14-tagged}

# SSLKEYLOGFILE Labels for ECH {#labels}

This document defines two new labels for SSLKEYLOGFILE format: ECH_SECRET and ECH_CONFIG. The client SHOULD log the labels if it offered ECH regardless of server acceptance. The server MAY log the labels only if it successfully decrypted and accepted ECH offered by the client. The 32-byte random value from the Outer ClientHello message is used as the client_random value for these log records. The client MUST NOT log the labels for connections that use the GREASE ECH extension (see Section 6.2 of {{!I-D.ietf-tls-esni}}).

## ECH_SECRET

This label corresponds to the KEM shared secret derived during the HPKE key schedule process. Length of the secret is defined by the KEM negotiated for use with ECH.

## ECH_CONFIG

This label is used to log the ECHConfig used for construction of the ECH extension. Note that the value is logged in hexadecimal representation, similarly to other entries in the SSLKEYLOGFILE.

# Client_random for other TLS 1.3 SSLKEYLOGFILE Entries

The SSLKEYLOGFILE uses the random value from the ClientHello message as a "connection identifier". This creates ambiguity since the TLS handshake with ECH contains two different random values, one in the Outer ClientHello structure and the second one in the Inner ClientHello.

The SSLKEYLOGFILE entries corresponding to TLS 1.3 secrets for connections that successfully negotiated ECH MUST use the random from the Inner ClientHello structure. In all other cases the random value from the Outer ClientHello structure MUST be used.

# Security Considerations

The applicability statement of {{!I-D.ietf-tls-keylogfile}} also applies to this document: if unauthorized entities gain access to the logged secrets then the core guarantees that TLS provides are completely undermined.

This specification extends the SSLKEYLOGFILE specification {{!I-D.ietf-tls-keylogfile}} and therefore introduces the following threats:

- Access to the ECH_SECRET record in the SSLKEYLOGFILE allows the attacker to decrypt the ECH extension and thereby reveal the content of the ClientHello message, including the payload of the Server Name Indication (SNI) extension.

- Access to the HPKE-established shared secret introduces a potential attack surface against the HPKE library since access to this keying material is normally not available otherwise.

Implementers MUST take measures to prevent unauthorized access to the SSLKEYLOGFILE text file.

As per the SSLKEYLOGFILE specification {{!I-D.ietf-tls-keylogfile}}, this extension is intended for use in environments where TLS protects only test data. While the access it provides to TLS connections can be valuable for debugging during development, this mechanism MUST NOT be used in production environments. To minimize the risk of accidental activation in production, implementers SHOULD incorporate appropriate compile-time controls.

# IANA Considerations

IANA is requested to create a new registry "SSLKEYLOGFILE Labels", within the existing "Transport Layer Security (TLS) Parameters" registry page.
This new registry reserves labels used for SSLKEYLOGFILE entries.
The initial contents of this registry are as follows.

| Value | Description | Reference |
| --- | --- | --- |
| CLIENT_RANDOM | Master secret in TLS 1.2 and earlier | {{!I-D.ietf-tls-keylogfile}} |
| CLIENT_EARLY_TRAFFIC_SECRET | Secret for client early data records | {{!I-D.ietf-tls-keylogfile}} |
| EARLY_EXPORTER_MASTER_SECRET | Early exporters secret | {{!I-D.ietf-tls-keylogfile}} |
| CLIENT_HANDSHAKE_TRAFFIC_SECRET | Secret protecting client handshake | {{!I-D.ietf-tls-keylogfile}} |
| SERVER_HANDSHAKE_TRAFFIC_SECRET | Secret protecting server handshake | {{!I-D.ietf-tls-keylogfile}} |
| CLIENT_TRAFFIC_SECRET_0 | Secret protecting client records post handshake | {{!I-D.ietf-tls-keylogfile}} |
| SERVER_TRAFFIC_SECRET_0 | Secret protecting server records post handshake | {{!I-D.ietf-tls-keylogfile}} |
| EXPORTER_SECRET | Exporter secret after handshake | {{!I-D.ietf-tls-keylogfile}} |

This documents defines two additional labels in {{labels}}:

- ECH_SECRET, which contains KEM shared secret for the ECH
- ECH_CONFIG, which contains ECHConfig used for construction of the ECH

New assignments in the "SSLKEYLOGFILE Labels" registry will be administered by IANA through Expert Review {{!RFC8126}}.
Designated Experts are requested to ensure that defined labels do not overlap in names or semantics, and have clear definitions.
   
Registration requests must be sent to the tls@ietf.org mailing list for review and comment, with an appropriate subject
(e.g., "Request for SSLKEYLOGFILE Label: example").

Within the review period of two weeks, the Designated Experts will either approve or deny the registration request,
communicating this decision to the review list and IANA.  Denials should include an explanation and, if applicable,
suggestions as to how to make the request successful.

IANA must only accept registry updates from the Designated Experts and should direct all requests for registration
to the TLS mailing list.
   
--- back

# Acknowledgments
{:numbered="false"}

We would like to thank Stephen Farrell, Rich Salz, Martin Thomson and Peter Wu for their review comments.
